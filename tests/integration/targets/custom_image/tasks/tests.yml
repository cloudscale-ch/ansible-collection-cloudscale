---
# This test triggers a bug in the api
#- name: Delete a non existent custom image by uuid
#  cloudscale_ch.cloud.custom_image:
#    uuid: "{{ item }}"
#    state: absent
#  loop:
#    - '415caea5-da7c-4aaa-aaaa-ececd38fb8ea'

- name: Fail delete a non existent custom image by name
  cloudscale_ch.cloud.custom_image:
    name: this-image-is-non-existent
    state: absent
  register: delete
  ignore_errors: true
- name: Verify Fail delete a non existend custom image by name
  assert:
    that:
      - delete is failed
      - delete.msg.startswith('state is absent but all of the following are missing\: uuid')

- name: Fail import a custom image without url
  cloudscale_ch.cloud.custom_image:
    name: "{{ cloudscale_resource_prefix }}-test-image"
    state: present
    slug: custom-ansible-image
    zones: lpg1
    user_data_handling: 'pass-through'
    tags:
      project: mars
    source_format: raw
  register: failed_import
  ignore_errors: true
- name: Verify Fail import a custom image without url
  assert:
    that:
      - failed_import.msg.startswith('Cannot import a new image without url.')

- name: Import a custom image and wait for import
  cloudscale_ch.cloud.custom_image:
    name: "{{ cloudscale_resource_prefix }}-test-image"
    state: present
    slug: custom-ansible-image
    url: "{{ image_url }}"
    zones: lpg1
    user_data_handling: 'pass-through'
    tags:
      project: mars
    source_format: raw
  register: image1
  retries: 15
  delay: 5
  until: image1.import_status is defined and image1.import_status == 'success' and image1.name is defined
- name: Verify import a custom image and wait for import
  assert:
    that:
      - image1.import_status == 'success'
      - image1.name == "{{ cloudscale_resource_prefix }}-test-image"

- name: Import a custom image without force (idempotency)
  cloudscale_ch.cloud.custom_image:
    name: "{{ cloudscale_resource_prefix }}-test-image"
    state: present
    slug: custom-ansible-image
    url: "{{ image_url }}"
    zones: lpg1
    user_data_handling: 'pass-through'
    tags:
      project: mars
    source_format: raw
  register: image
- name: Verify import a custom image without force
  assert:
    that:
      - image is not changed
      - image.name == "{{ cloudscale_resource_prefix }}-test-image"
      - image.uuid == image1.uuid

- name: Import a custom image with force
  cloudscale_ch.cloud.custom_image:
    name: "{{ cloudscale_resource_prefix }}-test-image"
    state: present
    slug: custom-ansible-image
    url: "{{ image_url }}"
    zones: lpg1
    user_data_handling: 'pass-through'
    tags:
      project: mars
    source_format: raw
    force: true
  register: image2
- name: Verify import a custom image with force
  assert:
    that:
      - image2 is changed
      - image2.custom_image.name == "{{ cloudscale_resource_prefix }}-test-image"
      - image2.uuid != image1.uuid

- name: Wait for import
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ image2.uuid }}"
  retries: 15
  delay: 5
  register: import_status
  until: import_status.import_status is defined and import_status.import_status == 'success' and import_status.name is defined
- name: Verify Wait for import
  assert:
    that:
      - import_status is not changed
      - import_status.name == "{{ cloudscale_resource_prefix }}-test-image"

- name: Get newest image by name
  cloudscale_ch.cloud.custom_image:
    name: "{{ cloudscale_resource_prefix }}-test-image"
  register: image_by_name
- name: Verify get newest image by name
  assert:
    that:
      - image_by_name is not changed
      - image_by_name.uuid == image2.uuid

- name: Get newest image by tags
  cloudscale_ch.cloud.custom_image:
    tags:
      project: mars
  register: image_by_tags
- name: Verify get newest image by tags
  assert:
    that:
      - image_by_tags is not changed
      - image_by_tags.uuid == image2.uuid

- name: Get newest image by slug
  cloudscale_ch.cloud.custom_image:
    slug: custom-ansible-image
  register: image_by_slug
- name: Verify get newest image by slug
  assert:
    that:
      - image_by_slug is not changed
      - image_by_slug.uuid == image2.uuid

- name: Update slug of a custom image
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ item }}"
    slug: ansible-image-slug
  register: image
  loop:
    - "{{ image2.uuid }}"
- name: Verify update slug of a custom image
  assert:
    that:
      - image is changed

- name: Get custom image with updated slug
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ item }}"
  loop:
    - "{{ image2.uuid }}"
  register: image
- name: Verify update slug of a custom image
  assert:
    that:
      - image.results[0].slug == "ansible-image-slug"

- name: Update tag of a custom image
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ item }}"
    tags:
      project: luna
  register: image
  loop:
    - "{{ image2.uuid }}"
- name: Verify update tag of a custom image
  assert:
    that:
      - image is changed
      - image.results[0].tags == "project: luna"

- name: Update user_data_handling of a custom image
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ item }}"
    user_data_handling: 'extend-cloud-config'
  register: image
  loop:
    - "{{ image2.uuid }}"
- name: Verify update user_data_handling of a custom image
  assert:
    that:
      - image is changed

- name: Get custom image with updated user_data_handling
  cloudscale_ch.cloud.custom_image:
    uuid: "{{ item }}"
  loop:
    - "{{ image2.uuid }}"
  register: image
- name: Verify update user_data_handling of a custom image
  assert:
    that:
      - image.results[0].user_data_handling == "extend-cloud-config"

- name: List all custom images
  uri:
    url: 'https://api.cloudscale.ch/v1/custom-images'
    headers:
      Authorization: 'Bearer {{ cloudscale_api_token }}'
    status_code: 200
  register: image_list
  until: image_list is not failed
  retries: 5
  delay: 3
- name: Verify that two custom images are created by this test run
  assert:
    that:
      - image_list.json | selectattr("name","search", "{{ cloudscale_resource_prefix }}" ) | list | length == 2
